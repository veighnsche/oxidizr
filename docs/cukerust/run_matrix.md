# BDD Run Matrix

This document summarizes how to run the Gherkin (Cucumber) BDD suites across all crates, how to select subsets by feature path, and where logs/artifacts live.

Artifacts generated by our static indexer live under `docs/cukerust/`:

- `docs/cukerust/step_index.json` — machine-readable index of all step definitions (pattern, kind, file, line, function)
- `docs/cukerust/tags.json` — inventory of all feature tags and counts
- `docs/cukerust/survey.json` — overview of the BDD wiring, entrypoints, CI, and quick wins

## Entrypoints and Feature Roots

- switchyard
  - Entrypoint: `cargo/switchyard/tests/bdd_main.rs`
  - Default features: `cargo/switchyard/SPEC/features/`
  - Env override: `SWITCHYARD_BDD_FEATURE_PATH`
- oxidizr-arch
  - Entrypoint: `cargo/oxidizr-arch/tests/bdd_main.rs`
  - Default features: `cargo/oxidizr-arch/tests/features/`
  - Env override: `OXIDIZR_ARCH_BDD_FEATURE_PATH`
- oxidizr-deb
  - Entrypoint: `cargo/oxidizr-deb/tests/bdd_main.rs`
  - Default features: `cargo/oxidizr-deb/tests/features/`
  - Env override: `OXIDIZR_DEB_BDD_FEATURE_PATH`
- oxidizr-cli-core
  - Entrypoint: `cargo/oxidizr-cli-core/tests/bdd_main.rs`
  - Default features: `cargo/oxidizr-cli-core/tests/features/`

All runners use tokio multi-thread runtime and `.fail_on_skipped()`.

## Local Commands

- switchyard (all features)
  - `cargo test -p switchyard-fs --features bdd --test bdd -- --nocapture`
- switchyard (single feature file)
  - `SWITCHYARD_BDD_FEATURE_PATH=SPEC/features/locking.feature cargo test -p switchyard-fs --features bdd --test bdd -- --nocapture`
- oxidizr-arch
  - `cargo test -p oxidizr-arch --features bdd -q`
  - Example subset: `OXIDIZR_ARCH_BDD_FEATURE_PATH=cargo/oxidizr-arch/tests/features/status_json.feature cargo test -p oxidizr-arch --features bdd -q`
- oxidizr-deb
  - `cargo test -p oxidizr-deb --features bdd -q`
  - Example subset: `OXIDIZR_DEB_BDD_FEATURE_PATH=cargo/oxidizr-deb/tests/features/replace_commit_with_locks.feature cargo test -p oxidizr-deb --features bdd -q`
- oxidizr-cli-core
  - `cargo test -p oxidizr-cli-core --features bdd -q`

Tip: append `-- --nocapture` to see cucumber output unbuffered in some runners.

## CI Jobs

- Primary BDD gate (switchyard): `.github/workflows/ci.yml` job `bdd`
  - Runs: `python3 scripts/bdd_filter_results.py --fail-only`
  - Artifact: `target/bdd-lastrun.log`
- Additional BDD jobs: `oxidizr-deb-bdd`, `oxidizr-arch-bdd`, `oxidizr-cli-core-bdd`

## Selecting Scenarios

The standard selection method is by feature path using the `*_BDD_FEATURE_PATH` env vars as shown above.

Note: scenario name and tag filters are not explicitly wired into the test entrypoints. If/when we enable cucumber CLI filters (e.g., `--tags`, `--name`), they would be passed after `--` to the test binary. Until then, rely on path selection and keeping feature files granular.

## Logs and Artifacts

- Switchyard CI artifact: `target/bdd-lastrun.log` (filtered to failures on CI)
- Golden fixtures diffs from `test_ci_runner.py` are uploaded under `golden-diff/`

## Tag Inventory

See `docs/cukerust/tags.json` for up-to-date tag counts. Example (excerpt):

```json
{
  "unique_tags": ["@REQ-A1", "@REQ-L1", "@REQ-O6", "@xfail", "@unit-bdd", ...],
  "counts": {
    "@REQ-D2": 3,
    "@REQ-F1": 3,
    "@REQ-F2": 3,
    "@xfail": 3,
    "@REQ-A1": 2,
    "@REQ-A2": 2,
    "@REQ-L1": 2
  }
}
```

## Quick Reference: Switchyard Helpers

- `scripts/bdd_filter_results.py` — reproducible local run with failure-only filtering. Example:

```bash
python3 scripts/bdd_filter_results.py --features SPEC/features/locking.feature --fail-only
```

## Known Pitfalls

- Runners fail on undefined or skipped steps due to `.fail_on_skipped()`.
- Scenario line-number selection is not supported at the entrypoint level; use path granularity.
- Steps span multiple crates; use `docs/cukerust/step_index.json` for cross-crate navigation.
