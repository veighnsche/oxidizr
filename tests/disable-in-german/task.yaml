summary: Disable only coreutils under a German locale, leaving sudo-rs enabled
execute: |
  set -euo pipefail
  source "$(dirname "$0")/../lib/uutils.sh"
  source "$(dirname "$0")/../lib/sudo-rs.sh"

  # Enable German locale (portable across distros)
  if grep -E -q '^#?\s*de_DE\.UTF-8\s+UTF-8' /etc/locale.gen; then
    sudo sed -i 's/^#\s*\(de_DE\.UTF-8\s\+UTF-8\)/\1/' /etc/locale.gen
  else
    echo 'de_DE.UTF-8 UTF-8' | sudo tee -a /etc/locale.gen >/dev/null
  fi
  # Generate locales if possible, but do not fail the suite if the generator is absent
  sudo locale-gen || true
  export LC_ALL=de_DE.UTF-8
  export LANGUAGE=de_DE.UTF-8
  export LANG=de_DE.UTF-8

  oxidizr-arch enable --yes
  oxidizr-arch disable --yes --experiments coreutils

  # Reset to English for assertions
  export LC_ALL=en_GB.UTF-8
  export LANGUAGE=en_GB.UTF-8
  export LANG=en_GB.UTF-8

  ensure_coreutils_absent
  ensure_sudors_installed
restore: |
  if [ -z "${CI:-}" ]; then
    oxidizr-arch disable --yes --all || true
  fi
