summary: Disable only coreutils under a German locale, leaving sudo-rs enabled
distro-check:
  - arch
  - manjaro
  - cachyos
  - endeavouros
execute: |-
  set -euo pipefail

  # Verify German locale is available (baked at image build time)
  if ! locale -a | grep -qi '^de_DE\.utf8$'; then
    echo "Required locale de_DE.UTF-8 is missing. Fix the Docker image (bake locales) and retry." >&2
    exit 1
  fi

  # Enable under default locale
  oxidizr-arch enable --yes

  # Disable coreutils under a German locale only (scoped to this single command)
  LC_ALL=de_DE.UTF-8 LANGUAGE=de_DE.UTF-8 LANG=de_DE.UTF-8 \
    oxidizr-arch disable --yes --experiments coreutils

  # Assertions
  if readlink /usr/bin/ls | grep -q uutils; then
      echo "coreutils should be disabled, but ls is still pointing to uutils"
      exit 1
  fi
  # sudo-rs must be installed and symlinked across supported distros
  pacman -Qi sudo-rs >/dev/null 2>&1 || { echo "sudo-rs should be installed"; exit 1; }
  readlink /usr/bin/sudo | grep -q "/usr/bin/sudo.sudo-rs" || { echo "sudo should point to sudo-rs"; exit 1; }
restore: |
  if [ -z "${CI:-}" ]; then
    oxidizr-arch disable --yes --all || true
  fi
